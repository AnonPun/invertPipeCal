<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบคำนวณขนาดและระดับก้นท่อระบายน้ำ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">

    <style>
        @media (max-width: 767px) {
            .table {
                font-size: 0.6rem;
                /* ลดขนาด font จากเดิม 0.875rem */
            }
        }

        /* Print Settings */
        @media print {
            @page {
                size: A4;
                margin: 1cm;
            }

            body {
                padding-top: 0 !important;
                background-color: white !important;
            }

            /* Hide everything that isn't the container */
            body>* {
                display: none !important;
            }

            /* Show container */
            .container {
                display: block !important;
                visibility: visible !important;
                width: 210mm !important;
                /* A4 Width */
                max-width: 210mm !important;
                margin: 0 auto !important;
                padding: 0 !important;
                box-shadow: none !important;
                position: absolute;
                top: 0;
                left: 0;
            }

            /* Ensure map resizes correctly */
            #report-map {
                width: 100% !important;
                height: 400px !important;
                /* Slightly smaller for print */
            }

            .leaflet-control-container {
                display: none !important;
                /* Hide map controls on print */
            }

            /* Ensure content inside container is visible */
            .container * {
                visibility: visible !important;
            }
        }

        body {
            font-family: 'Sarabun', sans-serif;
            padding-top: 100px;
            /* Using a common Thai font */
        }

        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }

        .navbar-brand .title-main {
            font-size: 1.1rem;
            font-weight: bold;
            color: #0d6efd;
        }

        .navbar-brand .title-sub {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .page-title {
            background-color: #0d6efd;
            color: white;
            padding: 0.75rem 1.25rem;
            font-size: 1.25rem;
            font-weight: bold;
        }

        .card-header {
            background-color: #e9ecef;
            font-weight: bold;
        }

        .form-label {
            font-weight: 500;
        }

        .form-control-plaintext {
            font-weight: normal;
        }

        .table {
            font-size: 0.875rem;
            border-color: #000;
        }

        .table tbody .highlight-yellow {
            vertical-align: middle;
            text-align: center;
            background-color: #fff3cd;
        }

        .table thead th,
        .table thead td {
            vertical-align: middle;
            text-align: left;
        }

        .table tbody th,
        .table tbody td {
            vertical-align: middle;
            text-align: left;
        }

        .card .table th,
        .card .table td {
            text-align: center;
            vertical-align: middle;
        }

        .footer-actions {
            padding: 1.5rem 0;
        }

        .badge.bg-warning {
            color: #000 !important;
        }

        .col-1x {
            width: 8.33%;
        }

        .col-2x {
            width: 16.66%;
        }

        .col-3x {
            width: 25%;
        }

        .col-1s {
            width: 5%;
        }

        .col-2s {
            width: 7.5%;
        }

        .col-3s {
            width: 6%;
        }

        .table .bg-custom-cyan {
            background-color: #E4F1FF;
        }

        .polygon-label {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #333;
            color: #000;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>

<body class="bg-dark">

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-sm py-2">
        <div class="container">

            <a class="navbar-brand" href="https://dds.bangkok.go.th">
                <img src="https://dds.bangkok.go.th/images/DDS_Logo_500.png" alt="Logo" style="height: 40px;">
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarContent">
                <div class="row w-100 align-items-center g-3 ms-auto">

                    <div class="col-12 col-lg-7 text-center">
                        <span class="h5 fw-bold text-white my-3 my-lg-0">
                            ระบบคำนวนขนาดและระดับก้นท่อระบายน้ำ
                        </span>
                    </div>

                    <div class="col-12 col-lg-5">
                        <div class="row g-2">
                            <div class="col-12 col-sm-6">
                                <a href="#" class="btn btn-light w-100">{{ session.get('user_name', session['user'])
                                    }}</a>
                            </div>
                            <div class="col-12 col-sm-6">
                                <a href="{{ url_for('logout') }}" class="btn btn-danger text-light w-100">ออกจากระบบ</a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </nav>

    <div class="container bg-white p-4 rounded shadow">
        <h2 class="page-title">รายการคำนวณ</h2>

        <div class="table-responsive">
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <td class="col-1x bg-custom-cyan">ชื่อ</td>
                        <td class="col-3x">รายการคำนวณขนาดและระดับก้นท่อระบายน้ำ</td>
                        <td class="col-1x bg-custom-cyan">ปี</td>
                        <td class="col-2x" id="rep-year">{{ project.year if project else '-' }}</td>
                        <td class="col-1x bg-custom-cyan">ส่วนราชการ</td>
                        <td id="rep-section">{{ user_info.section if user_info and user_info.section else
                            (project.user.section if project and project.user and project.user.section else '-') }}</td>
                    </tr>
                    <tr>
                        <td class="col-1x bg-custom-cyan">โครงการ</td>
                        <td colspan="3" id="rep-project-name">{{ project.project_name if project else '-' }}</td>
                        <td class="bg-custom-cyan"></td>
                        <td id="rep-division">{{ user_info.division if user_info and user_info.division else
                            (project.user.division if project and project.user and project.user.division else '-') }}
                        </td>
                    </tr>
                    <tr>
                        <td class="col-1x bg-custom-cyan">สำนักงานเขต</td>
                        <td class="col-1x" id="rep-district">{{ project.district if project else '-' }}</td>
                        <td class="col-1x bg-custom-cyan">แบบเลขที่</td>
                        <td id="rep-form-number">{{ project.form_number if project else '-' }}</td>
                        <td class="bg-custom-cyan"></td>
                        <td id="rep-office">
                            {% set u_office = user_info.office if user_info and user_info.office else
                            (project.user.office if project and project.user and project.user.office else '') %}
                            {% set u_dept = user_info.department if user_info and user_info.department else
                            (project.user.department if project and project.user and project.user.department else '') %}

                            {% if u_office or u_dept %}
                            {{ u_office }} {{ u_dept }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>

            </table>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered">
                <tbody>
                    <tr>
                        <th class="col-1x">ข้อมูล</th>
                        <td class="col-1x">- ระดับถนนเดิม</td>
                        <td class="col-1x highlight-yellow" id="rep-original-level">{{
                            "%.3f"|format(project.original_level) if project else '-' }}</td>
                        <td>ม.รทก.</td>
                        <td class="col-1x">- ความกว้างถนน</td>
                        <td class="col-2x" id="rep-road-width">{{ "%.2f"|format(project.road_width) if
                            project else '-' }}</td>
                        <td colspan="3">ม.</td>
                    </tr>

                    <tr>
                        <td></td>
                        <td>- ระดับถนนปรับปรุง</td>
                        <td class="highlight-yellow" id="rep-improved-level">{{ "%.3f"|format(project.improved_level) if
                            project else '-' }}</td>
                        <td class="col-1s">ม.รทก.</td>
                        <td>- คลองใกล้เคียง</td>
                        <td class="col-2x highlight-yellow" id="rep-nearby-canal">{{ project.nearby_canal if project
                            else '-'
                            }}</td>
                        <td class="col-1x">- ระดับขุดลอก</td>
                        <td class="col-1x highlight-yellow" id="rep-dredging-level">{{
                            "%.3f"|format(project.dredging_level) if project and project.dredging_level is not none else
                            '-' }}</td>
                        <td class="col-1s">ม.รทก.</td>
                    </tr>
                    <tr>
                        <td></td>
                        <td>- ความต่างของระดับ</td>
                        <td class="highlight-yellow" id="rep-level-diff">
                            {% if project %}
                            {{ "%.3f"|format(project.improved_level - project.original_level) }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>ม.</td>
                        <td>- อิทธิพลสถานีสูบน้ำ</td>
                        <td class="highlight-yellow" id="rep-pump-influence">{{ project.pump_influence if project else
                            '-' }}</td>
                        <td colspan="3"></td>
                </tbody>
            </table>
        </div>

        <div class="card mb-2">
            <div class="card-header">แผนที่</div>
            <div class="card-body p-0">
                <div id="report-map" style="height: 500px; width: 100%;"></div>
            </div>
        </div>

        <div class="card mb-2">
            <div class="card-header">ตารางคำนวณปริมาณน้ำท่าออกแบบ</div>
            <div class="card-body table-responsive">
                <table class="table table-bordered text-center" id="runoffTable">
                    <thead>
                        <tr>
                            <th>1</th>
                            <th>2</th>
                            <th>3</th>
                            <th>4</th>
                            <th>5</th>
                            <th>6</th>
                            <th>7</th>
                            <th>8</th>
                            <th>9</th>
                            <th>10</th>
                            <th>11</th>
                            <th>12</th>
                            <th>13</th>
                            <th>14</th>
                            <th>15</th>
                            <th>16</th>
                            <th>17</th>
                        </tr>

                        <tr>
                            <th colspan="2">Node</th>
                            <th rowspan="2" class="col-2s">หมายเลขท่อ</th>
                            <th colspan="2">ความยาว</th>
                            <th colspan="4">พื้นที่ที่เกิดปริมาณน้ำท่าออกแบบ</th>
                            <th rowspan="2" class="col-3s">สปส.<br>เฉลี่ย<br>C</th>
                            <th rowspan="2" class="col-3s">พื้นที่รวม<br>(ตร.ม.)<br>A<sub>T</sub></th>
                            <th rowspan="2" class="col-2s">พื้นที่สะสม<br>(ตร.ม.)<br>A<sub>S</sub></th>
                            <th colspan="3">เวลา (นาที)</th>
                            <th rowspan="2" class="col-2s">i<br>(มม./ชม.)</th>
                            <th rowspan="2">Q<br>(ลบ.ม./<br>วินาที)</th>
                        </tr>
                        <tr>
                            <th class="col-1s">Start</th>
                            <th class="col-1s">End</th>
                            <th class="col-1s">ท่อ<br>L<br>(ม.)</th>
                            <th class="col-1s">ท่อ<br>L<sub>S</sub><br>(ม.)</th>
                            <th class="col-3s">พื้นที่<br>A<sub>1</sub><br>(ตร.ม.)</th>
                            <th class="col-1s">สปส.<br>C<sub>1</sub></th>
                            <th class="col-3s">พื้นที่<br>A<sub>2</sub><br>(ตร.ม.)</th>
                            <th class="col-1s">สปส.<br>C<sub>2</sub></th>
                            <th class="col-1s">t<sub>0</sub></th>
                            <th class="col-1s">t<sub>pipe</sub></th>
                            <th class="col-1s">T<sub>C</sub></th>

                        </tr>
                    </thead>
                    <tbody id="runoffTableBody">
                        <!-- JS populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mb-2">
            <div class="card-header">ตารางคำนวณขนาดท่อระบายน้ำ</div>
            <div class="card-body table-responsive">
                <table class="table table-bordered text-center" id="pipeSizeTable">
                    <thead>
                        <tr>
                            <th class="col-1x">หมายเลขท่อ</th>
                            <th class="col-1x">ปริมาณน้ำฝน Q (ลบ.ม./วินาที)</th>
                            <th class="col-1x">จำนวน cell</th>
                            <th class="col-1x">ขนาดท่อที่เลือก</th>
                            <th class="col-1x">ความชัน</th>
                            <th class="col-1x">ความจุของท่อ Qp (ลบ.ม./วินาที)</th>
                            <th class="col-1x">ความเร็วสูงสุด Vp (ลบ.ม./วินาที)</th>
                            <th class="col-1x">ความเร็วที่เกิด V (ลบ.ม./วินาที)</th>
                            <th class="col-1x">การออกแบบ</th>
                        </tr>
                    </thead>
                    <tbody id="pipeSizeTableBody">
                        <!-- JS populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card mb-2">
            <div class="card-header">ตารางคำนวณระดับก้นท่อระบายน้ำ</div>
            <div class="card-body table-responsive">
                <table class="table table-bordered text-center" id="invertLevelTable">
                    <thead>
                        <tr>
                            <th>หมายเลขท่อ</th>
                            <th>ขนาดท่อ</th>
                            <th>ความยาว<br>(ม.)</th>
                            <th>จุดเริ่มต้น</th>
                            <th>ระดับก้นท่อเริ่มต้น<br>(ม.รทก.)</th>
                            <th>ทิศทาง</th>
                            <th>ความชัน</th>
                            <th>จุดเชื่อม</th>
                            <th>ระดับก้นท่อจุดเชื่อม<br>(ม.รทก.)</th>
                        </tr>
                    </thead>
                    <tbody id="invertLevelTableBody">
                        <!-- JS populated -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row justify-content-center p-2 gap-3 footer-actions">
            <div class="col-12 col-sm-3">
                <a href="{{ url_for('index') }}" class="btn btn-success w-100" id="btn-save-report">
                    <i class="bi bi-journal-check"></i> บันทึก</a>
            </div>
            <div class="col-12 col-sm-3">
                <button onclick="window.print()" class="btn btn-primary w-100">
                    <i class="bi bi-printer"></i> พิมพ์</button>
            </div>
            <div class="col-12 col-sm-3">
                {% if request.args.get('mode') == 'view' %}
                <a href="{{ url_for('index') }}" class="btn btn-secondary w-100">
                    <i class="bi bi-house-door-fill me-1"></i>กลับหน้าหลัก</a>
                {% else %}
                <a href="{{ url_for('invert_cal', project_id=project.id) if project else url_for('invert_cal') }}"
                    class="btn btn-danger w-100">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>ย้อนกลับ</a>
                {% endif %}
            </div>
        </div>

    </div>

    <!-- Hidden Fields for Jinja Interaction -->
    <input type="hidden" id="rawProjectId" value="{{ project.id if project else '' }}">
    <input type="hidden" id="rawViewMode" value="{{ 'true' if request.args.get('mode') == 'view' else 'false' }}">

    <!-- Hidden Fields for Large JSON Data -->
    <textarea id="rawDbInvert"
        style="display:none;">{{ (project.invert_data | safe) if (project and project.invert_data) else 'null' }}</textarea>
    <textarea id="rawDbCal"
        style="display:none;">{{ (project.cal_data | safe) if (project and project.cal_data) else 'null' }}</textarea>
    <textarea id="rawDbDesign"
        style="display:none;">{{ (project.design_data | safe) if (project and project.design_data) else 'null' }}</textarea>


    <textarea id="rawMapData"
        style="display:none;">{{ (project.map_data | safe) if (project and project.map_data) else 'null' }}</textarea>

    <!-- Leaflet & Turf -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Helper to parse JSON from textarea or default to null
        function getJsonFromElement(id) {
            const raw = document.getElementById(id).value;
            if (!raw || raw === 'null') return null;
            try {
                return JSON.parse(raw);
            } catch (e) {
                console.error('Error parsing JSON for ' + id, e);
                return null;
            }
        }

        const projectIdVal = document.getElementById('rawProjectId').value;
        const projectId = projectIdVal === '' ? null : projectIdVal;

        const isViewMode = document.getElementById('rawViewMode').value === 'true';

        // Load data from hidden fields
        const dbInvert = getJsonFromElement('rawDbInvert');
        const dbCal = getJsonFromElement('rawDbCal');
        const dbDesign = getJsonFromElement('rawDbDesign');
        const mapData = getJsonFromElement('rawMapData');

        // --- Initialize Map ---
        if (mapData) {
            const map = L.map('report-map').setView([13.754408, 100.499886], 13);
            L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }).addTo(map);

            const drawnItems = new L.FeatureGroup().addTo(map);
            const labelMarkers = new L.FeatureGroup().addTo(map);

            let nextPolygonId = 1;
            let nextPolylineId = 1;

            // Nodes Logic (Copied/Adapted from app.js)
            const nodes = [];
            let nextNodeId = 1;

            function getOrCreateNode(latlng, polylineId) {
                // Use a small tolerance for equality check
                let existingNode = nodes.find(n => {
                    // Manual distance check or Leaflet's equals with tolerance if available
                    // limit precision check
                    return Math.abs(n.latlng.lat - latlng.lat) < 1e-6 && Math.abs(n.latlng.lng - latlng.lng) < 1e-6;
                });

                if (!existingNode) {
                    const nodeLabel = `${nextNodeId}`;
                    const nodeMarker = L.circleMarker(latlng, {
                        radius: 6,
                        color: '#3388ff',
                        fillColor: '#ffffff',
                        fillOpacity: 1,
                        weight: 2
                    }).bindTooltip(nodeLabel, { permanent: true, direction: 'top', className: 'polygon-label' }).addTo(labelMarkers);

                    existingNode = { id: nextNodeId, latlng: latlng, labelMarker: nodeMarker, associatedPolylineIds: [] };
                    nodes.push(existingNode);
                    nextNodeId++;
                }
                if (!existingNode.associatedPolylineIds.includes(polylineId)) {
                    existingNode.associatedPolylineIds.push(polylineId);
                }
                return existingNode;
            }

            // Add Polygons
            if (mapData.polygons) {
                mapData.polygons.forEach(p => {
                    const layer = L.geoJSON(p.geojson, {
                        style: { color: '#FF9900', weight: 2 }
                    });
                    drawnItems.addLayer(layer);

                    // Add Label
                    // Prioritize p.area_m2 if available, otherwise calculate
                    let areaSqMeters = p.area_m2;
                    if (areaSqMeters === undefined || areaSqMeters === null) {
                        const rawArea = turf.area(p.geojson);
                        areaSqMeters = Math.round(rawArea * 10) / 10; // Round to 1 decimal place? app.js uses Math.round(rawArea / 10) * 10 
                        // Check app.js logic: Math.round(rawArea / 10) * 10  <- This rounds to nearest 10? 
                        // Wait, app.js says: Math.round(rawArea / 10) * 10;
                        // Let's match app.js exactly.
                        areaSqMeters = Math.round(rawArea / 10) * 10;
                    }

                    const centroid = turf.centroid(p.geojson);
                    const [lng, lat] = centroid.geometry.coordinates;
                    const polygonLabel = `A${nextPolygonId} = ${areaSqMeters.toFixed(2)} ตร.ม.`;

                    L.marker([lat, lng], { opacity: 0 })
                        .bindTooltip(polygonLabel, { permanent: true, direction: 'center', className: 'polygon-label' })
                        .addTo(labelMarkers);

                    nextPolygonId++;
                });
            }
            // Add Polylines
            if (mapData.polylines) {
                mapData.polylines.forEach(p => {
                    const layer = L.geoJSON(p.geojson, {
                        style: { color: '#0000CC', weight: 3 }
                    });
                    drawnItems.addLayer(layer);

                    const latlngs = layer.getLayers()[0].getLatLngs(); // geoJSON layer is a group, get first layer
                    const currentPolylineId = nextPolylineId++;



                    // Generate Nodes
                    latlngs.forEach(latlng => {
                        getOrCreateNode(latlng, currentPolylineId);
                    });

                    // Generate Segment Labels
                    for (let i = 0; i < latlngs.length - 1; i++) {
                        const p1 = latlngs[i];
                        const p2 = latlngs[i + 1];

                        const segmentLine = turf.lineString([[p1.lng, p1.lat], [p2.lng, p2.lat]]);
                        const rawLen = turf.length(segmentLine, { units: 'kilometers' }) * 1000;
                        const segmentLength = Math.round(rawLen / 10) * 10;

                        const midpointLat = (p1.lat + p2.lat) / 2;
                        const midpointLng = (p1.lng + p2.lng) / 2;

                        const segmentLabel = `P${currentPolylineId}-S${i + 1} = ${segmentLength.toFixed(2)} ม.`;

                        L.marker([midpointLat, midpointLng], { opacity: 0 })
                            .bindTooltip(segmentLabel, { permanent: true, direction: 'center', className: 'polygon-label' })
                            .addTo(labelMarkers);
                    }
                });
            }

            if (drawnItems.getLayers().length > 0) {
                map.fitBounds(drawnItems.getBounds());
            }
        } else {
            document.getElementById('report-map').innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted">ไม่พบข้อมูลแผนที่ (หรือยังไม่ได้บันทึกแผนที่)</div>';
        }


        document.getElementById('btn-save-report').addEventListener('click', async function (e) {
            e.preventDefault();

            if (projectId) {
                // Collect data from LocalStorage
                const mapData = localStorage.getItem('savedMapGeoJSON') ? JSON.parse(localStorage.getItem('savedMapGeoJSON')) : null;
                const calData = localStorage.getItem('mapPageTableData') ? JSON.parse(localStorage.getItem('mapPageTableData')) : null;

                const payload = {};
                if (mapData) payload.map_data = mapData;
                if (calData) payload.cal_data = calData;

                try {
                    const response = await fetch(`/api/save_project_data/${projectId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        alert('Warning: Failed to save project data to server.');
                    }
                } catch (error) {
                    console.error('Error saving:', error);
                    alert('Error saving data.');
                }
            }

            // Clear all project related data from LocalStorage
            localStorage.removeItem('projectInfoData');
            localStorage.removeItem('mapPageTableData');
            localStorage.removeItem('calTableData');
            localStorage.removeItem('polygonData');
            localStorage.removeItem('polylineData');
            localStorage.removeItem('savedMapGeoJSON');

            // Redirect to index
            window.location.href = "{{ url_for('index') }}";
        });

        document.addEventListener('DOMContentLoaded', () => {

            // 1. Populate Runoff Table (Table 2)
            // Priority: LocalStorage (Editing mode) > DB Cal Data (View or Fallback)
            const runoffBody = document.getElementById('runoffTableBody');
            const savedMapData = localStorage.getItem('mapPageTableData');

            let runoffData = null;
            if (dbCal) {
                runoffData = dbCal;
            } else if (!isViewMode && savedMapData) {
                runoffData = JSON.parse(savedMapData);
            }

            if (runoffData) {
                // Determine structure
                const renderRow = (rowVals) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                                <td>${rowVals[0]}</td>
                                <td>${rowVals[1]}</td>
                                <td>${rowVals[2]}</td>
                                <td>${parseFloat(rowVals[3]).toFixed(2)}</td>
                                <td>${parseFloat(rowVals[4]).toFixed(2)}</td>
                                <td>${rowVals[5]}</td>
                                <td>${rowVals[6]}</td>
                                <td>${rowVals[7]}</td>
                                <td>${rowVals[8]}</td>
                                <td>${rowVals[9]}</td>
                                <td>${rowVals[10]}</td>
                                <td>${rowVals[11]}</td>
                                <td>${rowVals[12]}</td>
                                <td>${rowVals[13]}</td>
                                <td>${rowVals[14]}</td>
                                <td>${rowVals[15]}</td>
                                <td>${rowVals[16]}</td>
                             `;
                    runoffBody.appendChild(tr);
                };

                if (Array.isArray(runoffData)) {
                    runoffData.forEach(item => {
                        if (item.rows) {
                            // It's a Group object
                            item.rows.forEach(row => renderRow(row));
                        } else if (Array.isArray(item)) {
                            // It's a direct row array? Unlikely but possible legacy
                            renderRow(item);
                        }
                    });
                }
            } else {
                runoffBody.innerHTML = '<tr><td colspan="17">ไม่พบข้อมูลคำนวณน้ำท่า</td></tr>';
            }

            // 2. Populate Pipe Size Table (Table 3)
            const pipeSizeBody = document.getElementById('pipeSizeTableBody');
            let pipeSizeData = null;

            if (dbDesign) {
                pipeSizeData = dbDesign;
            } else if (!isViewMode) {
                const lsData = localStorage.getItem('calTableData');
                if (lsData) pipeSizeData = JSON.parse(lsData);
            }

            if (pipeSizeData) {
                pipeSizeData.forEach(pipe => {
                    const trSize = document.createElement('tr');
                    let statusBadge = '';
                    if (pipe.status === 'OK') statusBadge = '<span class="badge bg-success">OK</span>';
                    else if (pipe.status === 'Warning') statusBadge = '<span class="badge bg-warning text-dark">Warning</span>';
                    else statusBadge = '<span class="badge bg-danger">NG</span>';

                    const sizeDisplay = (pipe.size && pipe.size !== '-') ? `ø ${pipe.size}` : '-';

                    trSize.innerHTML = `
                            <td>${pipe.id || '-'}</td>
                            <td>${pipe.q ? parseFloat(pipe.q).toFixed(4) : '-'}</td>
                            <td>${pipe.cell || 1}</td>
                            <td>${sizeDisplay}</td>
                            <td>${pipe.slope || '-'}</td>
                            <td>${pipe.qp || '-'}</td>
                            <td>${pipe.vp || '-'}</td>
                            <td>${pipe.v || '-'}</td>
                            <td>${statusBadge}</td>
                         `;
                    pipeSizeBody.appendChild(trSize);
                });
            } else {
                pipeSizeBody.innerHTML = '<tr><td colspan="9">ไม่พบข้อมูลคำนวณขนาดท่อ</td></tr>';
            }

            // 3. Populate Invert Level Table (Table 4)
            const invertBody = document.getElementById('invertLevelTableBody');
            let invertData = null;

            if (dbInvert) {
                invertData = dbInvert;
            } else if (pipeSizeData) {
                invertData = pipeSizeData;
            }

            if (invertData) {
                invertData.forEach(pipe => {
                    const hasInvert = pipe.pipeInvert !== undefined || pipe.startNode !== undefined;

                    if (hasInvert) {
                        const trInvert = document.createElement('tr');
                        const slopeDisp = (pipe.slopeSign && pipe.slopeValue) ?
                            `1:${pipe.slopeValue}` : (pipe.slope || '-');

                        trInvert.innerHTML = `
                                    <td>${pipe.id || '-'}</td>
                                    <td>${pipe.size || '-'}</td>
                                    <td>${pipe.length || '-'}</td>
                                    <td>${pipe.startNode || '-'}</td>
                                    <td>${pipe.pipeInvert || '-'}</td>
                                    <td>${pipe.slopeSign || '-'}</td>
                                    <td>${slopeDisp}</td>
                                    <td>${pipe.endNode || '-'}</td>
                                    <td>${pipe.invertConnect || '-'}</td>
                                 `;
                        invertBody.appendChild(trInvert);
                    }
                });

                if (invertBody.children.length === 0) {
                    invertBody.innerHTML = '<tr><td colspan="9">ไม่พบข้อมูลระดับก้นท่อ</td></tr>';
                }

            } else {
                invertBody.innerHTML = '<tr><td colspan="9">ไม่พบข้อมูลระดับก้นท่อ</td></tr>';
            }

            // 4. Fallback: Load Project Info from LocalStorage
            const projectDataLoc = localStorage.getItem('projectInfoData');
            if (!isViewMode && projectDataLoc) {
                const pData = JSON.parse(projectDataLoc);
                const setIfEmpty = (id, value, isNum = false, precision = 3) => {
                    const el = document.getElementById(id);
                    if (el && (el.innerText.trim() === '-' || el.innerText.trim() === '')) {
                        if (value) {
                            if (isNum) el.innerText = parseFloat(value).toFixed(precision);
                            else el.innerText = value;
                        }
                    }
                };
                if (!dbCal && !dbDesign && !dbInvert) {
                    setIfEmpty('rep-project-name', pData.project_name);
                }
            }
        });
    </script>

</body>

</html>