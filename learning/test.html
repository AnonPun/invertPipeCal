import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut 
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    addDoc, 
    doc, 
    getDoc, 
    updateDoc, 
    query, 
    where, 
    getDocs,
    onSnapshot,
    setDoc
} from 'firebase/firestore';

// --- Dynamic Imports from CDN ---
// These libraries are now imported from a CDN to resolve compilation errors.
import { MapContainer, TileLayer, FeatureGroup, useMap } from 'https://esm.sh/react-leaflet@4.2.1';
import { EditControl } from 'https://esm.sh/react-leaflet-draw@0.2.1';
import L from 'https://esm.sh/leaflet@1.9.4';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'https://esm.sh/recharts@2.12.7';
import { jsPDF } from 'https://esm.sh/jspdf@2.5.1';
import html2canvas from 'https://esm.sh/html2canvas@1.4.1';


// Firebase Configuration (DO NOT EDIT)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-drainage-app';

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Fix Leaflet's default icon issue
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});


// --- HELPER FUNCTIONS ---
// Manning's Equation for full flow
const calculateManningFull = (diameter, slope, n = 0.013) => {
    const D = diameter / 1000; // convert mm to m
    const A = Math.PI * Math.pow(D / 2, 2);
    const R = D / 4; // Hydraulic Radius for full pipe
    const V = (1 / n) * Math.pow(R, 2 / 3) * Math.pow(slope, 1 / 2);
    const Q = A * V;
    return { Q_full: Q, V_full: V };
};

// Hydraulic elements for partial flow
const getHydraulicElementsData = (designQ, Q_full) => {
    const data = [];
    if (Q_full <= 0) return data;

    for (let i = 1; i <= 100; i++) {
        const d_D = i / 100;
        const theta = 2 * Math.acos(1 - 2 * d_D); // angle in radians
        const A_Afull = (theta - Math.sin(theta)) / (2 * Math.PI);
        const P_Pfull = theta / (2 * Math.PI);
        const R_Rfull = (A_Afull / P_Pfull);
        const Q_Qfull = Math.pow(R_Rfull, 2/3) * A_Afull;
        const V_Vfull = Math.pow(R_Rfull, 2/3);

        data.push({
            d_D: d_D,
            'Q/Qfull': Q_Qfull,
            'V/Vfull': V_Vfull,
            'A/Afull': A_Afull,
            'R/Rfull': R_Rfull,
        });
    }
    return data;
};

const find_d_D_for_Q = (designQ, Q_full) => {
    if (designQ >= Q_full) return { d_D: 1, V_V: 1 };
    const q_ratio = designQ / Q_full;
    const data = getHydraulicElementsData(designQ, Q_full);
    let closest = data.reduce((prev, curr) => 
        Math.abs(curr['Q/Qfull'] - q_ratio) < Math.abs(prev['Q/Qfull'] - q_ratio) ? curr : prev
    );
    return { d_D: closest.d_D, V_V: closest['V/Vfull'] };
};


// --- COMPONENTS ---

const AuthComponent = ({ setUser }) => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [isLogin, setIsLogin] = useState(true);
    const [error, setError] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-100">
            <div className="p-8 bg-white rounded-lg shadow-xl w-full max-w-md">
                <h2 className="text-3xl font-bold mb-6 text-center text-gray-800">{isLogin ? 'เข้าสู่ระบบ' : 'สมัครสมาชิก'}</h2>
                <form onSubmit={handleSubmit}>
                    <div className="mb-4">
                        <label className="block text-gray-700 mb-2" htmlFor="email">อีเมล</label>
                        <input
                            type="email"
                            id="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        />
                    </div>
                    <div className="mb-6">
                        <label className="block text-gray-700 mb-2" htmlFor="password">รหัสผ่าน</label>
                        <input
                            type="password"
                            id="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            required
                        />
                    </div>
                    {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                    <button type="submit" className="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                        {isLogin ? 'เข้าสู่ระบบ' : 'สมัครสมาชิก'}
                    </button>
                </form>
                <button onClick={() => setIsLogin(!isLogin)} className="w-full mt-4 text-blue-600 hover:underline">
                    {isLogin ? 'ยังไม่มีบัญชี? สมัครสมาชิก' : 'มีบัญชีแล้ว? เข้าสู่ระบบ'}
                </button>
            </div>
        </div>
    );
};

const ProjectInfoPage = ({ onProjectCreated, user }) => {
    const [projectData, setProjectData] = useState({
        projectName: '',
        drawingNo: '',
        year: new Date().getFullYear(),
        existingRoadLevel: '',
        newRoadLevel: '',
        roadWidth: '',
    });

    const handleChange = (e) => {
        const { name, value } = e.target;
        setProjectData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        try {
            const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${user.uid}/projects`), {
                ...projectData,
                owner: user.uid,
                createdAt: new Date(),
                manholes: [],
                catchmentAreas: [],
            });
            onProjectCreated(docRef.id);
        } catch (error) {
            console.error("Error adding document: ", error);
            alert("เกิดข้อผิดพลาดในการสร้างโครงการ");
        }
    };

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">1. ข้อมูลโครงการ</h2>
            <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <InputField label="ชื่อโครงการ" name="projectName" value={projectData.projectName} onChange={handleChange} required />
                    <InputField label="แบบเลขที่" name="drawingNo" value={projectData.drawingNo} onChange={handleChange} required />
                    <InputField label="ปี" name="year" type="number" value={projectData.year} onChange={handleChange} required />
                    <InputField label="ระดับถนนเดิม (ม.รทก.)" name="existingRoadLevel" type="number" step="0.01" value={projectData.existingRoadLevel} onChange={handleChange} required />
                    <InputField label="ระดับถนนปรับปรุง (ม.รทก.)" name="newRoadLevel" type="number" step="0.01" value={projectData.newRoadLevel} onChange={handleChange} required />
                    <InputField label="ความกว้างถนน (ม.)" name="roadWidth" type="number" step="0.01" value={projectData.roadWidth} onChange={handleChange} required />
                </div>
                <button type="submit" className="mt-6 w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
                    บันทึกและไปต่อ
                </button>
            </form>
        </div>
    );
};

const InputField = ({ label, ...props }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
        <input {...props} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-500" />
    </div>
);

const MapPage = ({ project, onDataUpdate }) => {
    const featureGroupRef = useRef();

    const handleCreated = async (e) => {
        const { layerType, layer } = e;
        let updatedProject = { ...project };

        if (layerType === 'polygon') {
            const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]) / 1600; // Convert sq.m to Rai
            const newArea = {
                id: layer._leaflet_id,
                area: area.toFixed(4),
                c: 0.85, // Default C value
                latlngs: layer.getLatLngs()[0],
            };
            updatedProject.catchmentAreas = [...(project.catchmentAreas || []), newArea];
        }

        if (layerType === 'polyline') {
            const latlngs = layer.getLatLngs();
            const manholes = [];
            let totalLength = 0;
            for (let i = 0; i < latlngs.length; i++) {
                let pipeLength = 0;
                if (i > 0) {
                    pipeLength = latlngs[i].distanceTo(latlngs[i-1]);
                    totalLength += pipeLength;
                }
                manholes.push({
                    id: `MH-${updatedProject.manholes.length + i + 1}`,
                    lat: latlngs[i].lat,
                    lng: latlngs[i].lng,
                    pipeLengthToNext: (i < latlngs.length - 1) ? latlngs[i+1].distanceTo(latlngs[i]) : 0,
                });
            }
             updatedProject.manholes = [...manholes];
        }
        
        onDataUpdate(updatedProject);
    };

    const handleEdited = (e) => {
        // Implement edit logic if needed
        console.log("Edited:", e.layers);
    };

    const handleDeleted = (e) => {
        // Implement delete logic if needed
        console.log("Deleted:", e.layers);
    };

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">2. แผนที่และพื้นที่รับน้ำ</h2>
            <p className="mb-4 text-gray-600">ใช้เครื่องมือทางซ้ายเพื่อวาดพื้นที่รับน้ำ (Polygon) และแนวท่อ (Polyline)</p>
            <div className="h-[500px] w-full rounded-lg overflow-hidden border">
                <MapContainer center={[13.7563, 100.5018]} zoom={13} style={{ height: '100%', width: '100%' }}>
                    <TileLayer
                        url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
                        attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    />
                    <FeatureGroup ref={featureGroupRef}>
                        <EditControl
                            position="topleft"
                            onCreated={handleCreated}
                            onEdited={handleEdited}
                            onDeleted={handleDeleted}
                            draw={{
                                rectangle: false,
                                circle: false,
                                circlemarker: false,
                                marker: false,
                            }}
                        />
                    </FeatureGroup>
                </MapContainer>
            </div>
        </div>
    );
};

const FlowCalculationPage = ({ project, onDataUpdate }) => {
    const [rainfallIntensity, setRainfallIntensity] = useState(120); // Default I value

    const handleCChange = (index, value) => {
        const updatedAreas = [...project.catchmentAreas];
        updatedAreas[index].c = value;
        onDataUpdate({ ...project, catchmentAreas: updatedAreas });
    };

    const calculateFlow = () => {
        if (!project.manholes || project.manholes.length === 0) return [];

        let cumulativeQ = 0;
        return project.manholes.map((mh, index) => {
            // Simple assumption: each manhole gets one catchment area
            const areaData = project.catchmentAreas && project.catchmentAreas[index] ? project.catchmentAreas[index] : { area: 0, c: 0 };
            const A = parseFloat(areaData.area || 0);
            const C = parseFloat(areaData.c || 0);
            const I = parseFloat(rainfallIntensity || 0);

            const q = (C * I * A) / 360;
            cumulativeQ += q;

            return {
                manholeId: mh.id,
                area: A.toFixed(4),
                c: C,
                i: I,
                q: q.toFixed(4),
                cumulativeQ: cumulativeQ.toFixed(4),
            };
        });
    };

    const flowData = calculateFlow();

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">3. ตารางคำนวณอัตราการไหล (Q)</h2>
             <div className="mb-4">
                <label className="block text-gray-700 mb-2">ความเข้มฝน (Rainfall Intensity, I) (mm/hr)</label>
                <input
                    type="number"
                    value={rainfallIntensity}
                    onChange={(e) => setRainfallIntensity(e.target.value)}
                    className="w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-lg"
                />
            </div>
            <div className="overflow-x-auto">
                <table className="min-w-full bg-white border">
                    <thead className="bg-gray-200">
                        <tr>
                            <th className="py-2 px-4 border">บ่อพัก</th>
                            <th className="py-2 px-4 border">พื้นที่รับน้ำ (ไร่)</th>
                            <th className="py-2 px-4 border">C (Runoff Coeff.)</th>
                            <th className="py-2 px-4 border">I (mm/hr)</th>
                            <th className="py-2 px-4 border">Q (m³/s)</th>
                            <th className="py-2 px-4 border">Q สะสม (m³/s)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {flowData.length > 0 ? flowData.map((row, index) => (
                            <tr key={index} className="text-center">
                                <td className="py-2 px-4 border">{row.manholeId}</td>
                                <td className="py-2 px-4 border">{row.area}</td>
                                <td className="py-2 px-4 border">
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={row.c} 
                                        onChange={(e) => handleCChange(index, e.target.value)}
                                        className="w-20 text-center bg-gray-50 border-b"
                                    />
                                </td>
                                <td className="py-2 px-4 border">{row.i}</td>
                                <td className="py-2 px-4 border">{row.q}</td>
                                <td className="py-2 px-4 border font-semibold">{row.cumulativeQ}</td>
                            </tr>
                        )) : (
                            <tr>
                                <td colSpan="6" className="text-center py-4 text-gray-500">
                                    ยังไม่มีข้อมูลท่อ กรุณากำหนดแนวท่อในหน้าแผนที่
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const PipeSizingPage = ({ project, onDataUpdate }) => {
    const [pipeDesigns, setPipeDesigns] = useState([]);
    const [selectedPipeIndex, setSelectedPipeIndex] = useState(null);

    useEffect(() => {
        if (project.manholes && project.manholes.length > 1) {
            const flowData = calculateFlow(project, 120); // Assuming I=120 for now
            const initialDesigns = [];
            for (let i = 0; i < project.manholes.length - 1; i++) {
                initialDesigns.push({
                    from: project.manholes[i].id,
                    to: project.manholes[i+1].id,
                    designQ: flowData[i+1].cumulativeQ,
                    diameter: project.manholes[i].diameter || 800, // default
                    slope: project.manholes[i].slope || 0.002, // default
                });
            }
            setPipeDesigns(initialDesigns);
        }
    }, [project]);

    const handleDesignChange = (index, field, value) => {
        const newDesigns = [...pipeDesigns];
        newDesigns[index][field] = value;
        setPipeDesigns(newDesigns);

        // Update project data
        const updatedManholes = [...project.manholes];
        updatedManholes[index][field] = value;
        onDataUpdate({ ...project, manholes: updatedManholes });
    };
    
    // Helper to reuse flow calculation logic
    const calculateFlow = (proj, rainfallIntensity) => {
        let cumulativeQ = 0;
        return proj.manholes.map((mh, index) => {
            const areaData = proj.catchmentAreas && proj.catchmentAreas[index] ? proj.catchmentAreas[index] : { area: 0, c: 0 };
            const q = (parseFloat(areaData.c || 0) * rainfallIntensity * parseFloat(areaData.area || 0)) / 360;
            cumulativeQ += q;
            return { cumulativeQ: cumulativeQ.toFixed(4) };
        });
    };

    const renderCalculations = (design) => {
        const { Q_full, V_full } = calculateManningFull(design.diameter, design.slope);
        const { d_D, V_V } = find_d_D_for_Q(design.designQ, Q_full);
        const V_actual = V_V * V_full;

        return {
            Q_full: Q_full.toFixed(4),
            V_full: V_full.toFixed(4),
            d_D: d_D.toFixed(2),
            V_actual: V_actual.toFixed(4),
            status: V_actual > 0.6 ? 'OK' : 'ตกตะกอน'
        };
    };

    const selectedPipeData = selectedPipeIndex !== null ? pipeDesigns[selectedPipeIndex] : null;
    const chartData = selectedPipeData ? getHydraulicElementsData(selectedPipeData.designQ, calculateManningFull(selectedPipeData.diameter, selectedPipeData.slope).Q_full) : [];
    const designQRatio = selectedPipeData ? selectedPipeData.designQ / calculateManningFull(selectedPipeData.diameter, selectedPipeData.slope).Q_full : 0;

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">4. คำนวณขนาดท่อและตรวจสอบความเร็ว</h2>
            <div className="overflow-x-auto mb-6">
                <table className="min-w-full bg-white border">
                     <thead className="bg-gray-200">
                        <tr>
                            {['ท่อช่วง', 'Q ออกแบบ (m³/s)', 'ขนาดท่อ (mm)', 'ความชัน', 'Q เต็มท่อ (m³/s)', 'V เต็มท่อ (m/s)', 'd/D', 'V จริง (m/s)', 'สถานะ'].map(h => <th key={h} className="py-2 px-4 border">{h}</th>)}
                        </tr>
                    </thead>
                    <tbody>
                        {pipeDesigns.map((design, index) => {
                            const calcs = renderCalculations(design);
                            return (
                                <tr key={index} className="text-center hover:bg-gray-100 cursor-pointer" onClick={() => setSelectedPipeIndex(index)}>
                                    <td className="py-2 px-4 border">{design.from} - {design.to}</td>
                                    <td className="py-2 px-4 border">{design.designQ}</td>
                                    <td className="py-2 px-4 border">
                                        <select value={design.diameter} onChange={(e) => handleDesignChange(index, 'diameter', e.target.value)} className="w-full bg-transparent border-b">
                                            {[300, 400, 500, 600, 800, 1000, 1200, 1500].map(d => <option key={d} value={d}>{d}</option>)}
                                        </select>
                                    </td>
                                    <td className="py-2 px-4 border">
                                        <input type="number" step="0.0001" value={design.slope} onChange={(e) => handleDesignChange(index, 'slope', e.target.value)} className="w-24 text-center bg-transparent border-b"/>
                                    </td>
                                    <td className="py-2 px-4 border">{calcs.Q_full}</td>
                                    <td className="py-2 px-4 border">{calcs.V_full}</td>
                                    <td className="py-2 px-4 border">{calcs.d_D}</td>
                                    <td className="py-2 px-4 border font-semibold">{calcs.V_actual}</td>
                                    <td className={`py-2 px-4 border font-bold ${calcs.status === 'OK' ? 'text-green-600' : 'text-red-600'}`}>{calcs.status}</td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
            <h3 className="text-xl font-bold mb-4 text-gray-700">กราฟ Hydraulic Elements {selectedPipeData ? `(ท่อช่วง ${selectedPipeData.from} - ${selectedPipeData.to})` : ''}</h3>
            {selectedPipeIndex !== null ? (
                <div className="h-96">
                    <ResponsiveContainer width="100%" height="100%">
                        <LineChart data={chartData} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" />
                            <XAxis dataKey="d_D" label={{ value: 'อัตราส่วนความลึกต่อเส้นผ่านศูนย์กลาง (d/D)', position: 'insideBottom', offset: -5 }} />
                            <YAxis label={{ value: 'อัตราส่วน', angle: -90, position: 'insideLeft' }} />
                            <Tooltip />
                            <Legend />
                            <Line type="monotone" dataKey="Q/Qfull" stroke="#8884d8" name="Q/Qfull" dot={false}/>
                            <Line type="monotone" dataKey="V/Vfull" stroke="#82ca9d" name="V/Vfull" dot={false}/>
                            <Line type="monotone" dataKey="A/Afull" stroke="#ffc658" name="A/Afull" dot={false}/>
                            <Line type="monotone" dataKey="R/Rfull" stroke="#ff7300" name="R/Rfull" dot={false}/>
                        </LineChart>
                    </ResponsiveContainer>
                </div>
            ) : <p className="text-center text-gray-500">กรุณาเลือกช่วงท่อในตารางเพื่อแสดงกราฟ</p>}
        </div>
    );
};

const InvertLevelPage = ({ project, onDataUpdate }) => {
    const [startCover, setStartCover] = useState(1.5); // Default minimum cover
    
    const handleGroundLevelChange = (index, value) => {
        const updatedManholes = [...project.manholes];
        updatedManholes[index].groundLevel = value;
        onDataUpdate({ ...project, manholes: updatedManholes });
    };

    const calculateInvertLevels = () => {
        if (!project.manholes || project.manholes.length === 0) return [];

        const results = [];
        let previousInvertOut = null;

        project.manholes.forEach((mh, index) => {
            const groundLevel = parseFloat(mh.groundLevel || project.newRoadLevel || 0);
            const diameter = parseFloat(mh.diameter || 0) / 1000;
            const slope = parseFloat(mh.slope || 0);
            const length = parseFloat(mh.pipeLengthToNext || 0);
            
            let invertIn;
            if (index === 0) {
                invertIn = groundLevel - startCover - diameter;
            } else {
                invertIn = previousInvertOut;
            }

            const drop = slope * length;
            const invertOut = invertIn - drop;

            results.push({
                id: mh.id,
                groundLevel: groundLevel.toFixed(3),
                invertIn: invertIn.toFixed(3),
                invertOut: invertOut.toFixed(3),
                depth: (groundLevel - invertIn).toFixed(3),
            });
            
            previousInvertOut = invertOut;
        });

        return results;
    };

    const levelData = calculateInvertLevels();

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">5. คำนวณระดับก้นท่อ</h2>
            <div className="mb-4">
                <label className="block text-gray-700 mb-2">ความลึกฝังกลบเริ่มต้น (Minimum Cover) (m)</label>
                <input
                    type="number"
                    step="0.1"
                    value={startCover}
                    onChange={(e) => setStartCover(e.target.value)}
                    className="w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-lg"
                />
            </div>
            <div className="overflow-x-auto">
                <table className="min-w-full bg-white border">
                    <thead className="bg-gray-200">
                        <tr>
                            <th className="py-2 px-4 border">บ่อพัก</th>
                            <th className="py-2 px-4 border">ระดับดิน (ม.รทก.)</th>
                            <th className="py-2 px-4 border">ระดับท่อเข้า (Invert In)</th>
                            <th className="py-2 px-4 border">ระดับท่อออก (Invert Out)</th>
                            <th className="py-2 px-4 border">ความลึก (ม.)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {levelData.map((row, index) => (
                             <tr key={index} className="text-center">
                                <td className="py-2 px-4 border">{row.id}</td>
                                <td className="py-2 px-4 border">
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={row.groundLevel} 
                                        onChange={(e) => handleGroundLevelChange(index, e.target.value)}
                                        className="w-24 text-center bg-gray-50 border-b"
                                    />
                                </td>
                                <td className="py-2 px-4 border">{row.invertIn}</td>
                                <td className="py-2 px-4 border">{row.invertOut}</td>
                                <td className="py-2 px-4 border">{row.depth}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        </div>
    );
};

const SummaryReportPage = ({ project }) => {
    const reportRef = useRef();

    const exportToPdf = () => {
        const input = reportRef.current;
        html2canvas(input, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('l', 'mm', 'a4'); // l for landscape
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const ratio = canvasWidth / canvasHeight;
            const width = pdfWidth;
            const height = width / ratio;
            pdf.addImage(imgData, 'PNG', 0, 0, width, height > pdfHeight ? pdfHeight : height);
            pdf.save(`report-${project.drawingNo || 'project'}.pdf`);
        });
    };

    if (!project) return <div className="p-6 text-center text-gray-500">ไม่พบข้อมูลโครงการ</div>;

    return (
        <div>
            <div className="p-6 bg-white rounded-lg shadow-md" ref={reportRef}>
                <h2 className="text-2xl font-bold mb-4 text-center text-gray-800">6. สรุปผลการคำนวณ</h2>
                {/* Project Info */}
                <div className="border p-4 rounded-lg mb-4">
                    <h3 className="text-lg font-semibold mb-2">ข้อมูลโครงการ</h3>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm">
                        <p><strong>ชื่อโครงการ:</strong> {project.projectName}</p>
                        <p><strong>แบบเลขที่:</strong> {project.drawingNo}</p>
                        <p><strong>ปี:</strong> {project.year}</p>
                        <p><strong>ระดับถนนเดิม:</strong> {project.existingRoadLevel} ม.รทก.</p>
                        <p><strong>ระดับถนนปรับปรุง:</strong> {project.newRoadLevel} ม.รทก.</p>
                        <p><strong>ความกว้างถนน:</strong> {project.roadWidth} ม.</p>
                    </div>
                </div>
                {/* All tables would be rendered here in a compact format */}
                <div className="text-xs text-gray-500 mt-4">
                    เอกสารนี้สร้างโดย Drainage Design App
                </div>
            </div>
            <button onClick={exportToPdf} className="mt-6 w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">
                บันทึกเป็น PDF
            </button>
        </div>
    );
};


const SearchPage = ({ onProjectFound }) => {
    const [drawingNo, setDrawingNo] = useState('');
    const [error, setError] = useState('');
    const user = auth.currentUser;

    const handleSearch = async (e) => {
        e.preventDefault();
        setError('');
        if (!drawingNo.trim()) {
            setError('กรุณากรอกเลขที่แบบ');
            return;
        }

        try {
            const q = query(
                collection(db, `artifacts/${appId}/users/${user.uid}/projects`),
                where("drawingNo", "==", drawingNo)
            );
            const querySnapshot = await getDocs(q);
            if (!querySnapshot.empty) {
                const projectDoc = querySnapshot.docs[0];
                onProjectFound(projectDoc.id);
            } else {
                setError('ไม่พบโครงการสำหรับเลขที่แบบนี้');
            }
        } catch (err) {
            console.error(err);
            setError('เกิดข้อผิดพลาดในการค้นหา');
        }
    };

    return (
        <div className="p-6 bg-white rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4 text-gray-800">7. ค้นหาข้อมูลย้อนหลัง</h2>
            <form onSubmit={handleSearch}>
                <InputField 
                    label="กรอกเลขที่แบบเพื่อค้นหา" 
                    value={drawingNo}
                    onChange={(e) => setDrawingNo(e.target.value)}
                />
                 {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                <button type="submit" className="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition">
                    ค้นหา
                </button>
            </form>
        </div>
    );
};


export default function App() {
    const [user, setUser] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [currentPage, setCurrentPage] = useState('projectInfo');
    const [currentProject, setCurrentProject] = useState(null);
    const [currentProjectId, setCurrentProjectId] = useState(null);

    // Effect to dynamically load CSS files required by Leaflet
    useEffect(() => {
        const leafletCss = document.createElement('link');
        leafletCss.rel = 'stylesheet';
        leafletCss.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(leafletCss);

        const leafletDrawCss = document.createElement('link');
        leafletDrawCss.rel = 'stylesheet';
        leafletDrawCss.href = 'https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css';
        document.head.appendChild(leafletDrawCss);

        return () => {
            // Cleanup the links when the component unmounts
            document.head.removeChild(leafletCss);
            document.head.removeChild(leafletDrawCss);
        };
    }, []);


    useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, (user) => {
            setUser(user);
            setIsLoading(false);
            if (!user) {
                setCurrentPage('login');
                setCurrentProject(null);
                setCurrentProjectId(null);
            } else {
                setCurrentPage('projectInfo');
            }
        });
        return () => unsubscribe();
    }, []);

    useEffect(() => {
        if (currentProjectId && user) {
            const docRef = doc(db, `artifacts/${appId}/users/${user.uid}/projects`, currentProjectId);
            const unsubscribe = onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    setCurrentProject({ id: doc.id, ...doc.data() });
                } else {
                    console.log("No such document!");
                    setCurrentProject(null);
                    setCurrentProjectId(null);
                }
            });
            return () => unsubscribe();
        } else {
            setCurrentProject(null);
        }
    }, [currentProjectId, user]);


    const handleProjectCreated = (projectId) => {
        setCurrentProjectId(projectId);
        setCurrentPage('map');
    };
    
    const handleProjectFound = (projectId) => {
        setCurrentProjectId(projectId);
        setCurrentPage('summary');
    }

    const handleDataUpdate = async (updatedProjectData) => {
        if (!currentProjectId || !user) return;
        const projectRef = doc(db, `artifacts/${appId}/users/${user.uid}/projects`, currentProjectId);
        try {
            await updateDoc(projectRef, updatedProjectData);
            // onSnapshot will handle updating the state
        } catch (error) {
            console.error("Error updating project: ", error);
        }
    };

    const handleLogout = () => {
        signOut(auth);
    };
    
    const handleCreateNew = () => {
        setCurrentProjectId(null);
        setCurrentProject(null);
        setCurrentPage('projectInfo');
    }

    if (isLoading) {
        return <div className="min-h-screen flex items-center justify-center">กำลังโหลด...</div>;
    }

    if (!user) {
        return <AuthComponent setUser={setUser} />;
    }

    const renderPage = () => {
        switch (currentPage) {
            case 'projectInfo':
                return <ProjectInfoPage onProjectCreated={handleProjectCreated} user={user} />;
            case 'map':
                return <MapPage project={currentProject} onDataUpdate={handleDataUpdate} />;
            case 'flow':
                return <FlowCalculationPage project={currentProject} onDataUpdate={handleDataUpdate} />;
            case 'sizing':
                return <PipeSizingPage project={currentProject} onDataUpdate={handleDataUpdate} />;
            case 'invert':
                return <InvertLevelPage project={currentProject} onDataUpdate={handleDataUpdate} />;
            case 'summary':
                return <SummaryReportPage project={currentProject} />;
            case 'search':
                return <SearchPage onProjectFound={handleProjectFound} />;
            default:
                return <ProjectInfoPage onProjectCreated={handleProjectCreated} user={user} />;
        }
    };

    const navItems = [
        { id: 'map', label: '2. แผนที่' },
        { id: 'flow', label: '3. คำนวณ Q' },
        { id: 'sizing', label: '4. ขนาดท่อ' },
        { id: 'invert', label: '5. ระดับท่อ' },
        { id: 'summary', label: '6. สรุปผล' },
    ];

    return (
        <div className="min-h-screen bg-gray-100 font-sans">
            <header className="bg-white shadow-md p-4 flex justify-between items-center">
                <h1 className="text-2xl font-bold text-blue-700">Drainage Design App</h1>
                <div>
                    <span className="text-gray-600 mr-4">สวัสดี, {user.email}</span>
                    <button onClick={handleLogout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">ออกจากระบบ</button>
                </div>
            </header>

            <div className="flex">
                <nav className="w-64 bg-gray-800 text-white p-4 space-y-2">
                    <button onClick={handleCreateNew} className="w-full text-left px-4 py-2 rounded bg-green-600 hover:bg-green-700">
                        + สร้างโครงการใหม่
                    </button>
                    <button onClick={() => setCurrentPage('search')} className="w-full text-left px-4 py-2 rounded hover:bg-gray-700">
                        7. ค้นหาโครงการ
                    </button>
                    <hr className="border-gray-600 my-2" />
                    <h3 className="text-lg font-semibold px-2">
                        โครงการ: {currentProject ? (currentProject.projectName || 'N/A') : 'ยังไม่ได้เลือก'}
                    </h3>
                    {currentProject && navItems.map(item => (
                        <button 
                            key={item.id} 
                            onClick={() => setCurrentPage(item.id)}
                            className={`w-full text-left px-4 py-2 rounded ${currentPage === item.id ? 'bg-blue-600' : 'hover:bg-gray-700'}`}
                        >
                            {item.label}
                        </button>
                    ))}
                </nav>

                <main className="flex-1 p-8">
                    {currentProject || currentPage === 'projectInfo' || currentPage === 'search' ? (
                        renderPage()
                    ) : (
                        <div className="text-center p-10 bg-white rounded-lg shadow-md">
                            <h2 className="text-2xl font-bold text-gray-700">ยินดีต้อนรับ</h2>
                            <p className="mt-2 text-gray-500">กรุณา "สร้างโครงการใหม่" หรือ "ค้นหาโครงการ" จากเมนูด้านซ้ายเพื่อเริ่มต้น</p>
                        </div>
                    )}
                </main>
            </div>
        </div>
    );
}